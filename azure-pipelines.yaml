trigger:
  branches:
    include:
    - main
  paths:
    exclude:
    - README.md
    - .gitignore
    - screenshots/

name: DevOps Pipeline
variables:
  InfraProvisioningResoureGroupName: group20210504
  tfBackendStorageAccountName: tfbackend20210504
  tfBackendStorageContainerName: tf-backend-files-20210504
  tfBackendFileName: tf-state-file-20210504
  tfvarsFile: dev.tfvars
  python.version: '3.7.6'
stages:
- stage: Build
  jobs:
  - job: ProvisionInfrastructure
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: echo "provisioned infrastructure"
      displayName: 'Terraform Init, Plan and Apply'
  - job: UploadPackage
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: echo "uploaded package"
      displayName: 'Terraform Init, Plan and Apply'
- stage: Deploy
  jobs:
  - deployment: DeployPackage
    displayName: Deploy Package
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'APP'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: 'Deploy Azure Web App'
            inputs:
              azureSubscription: 'dev-sp'
              appName: 'webapp20210504-AppService'
              appType: webApp
              package: $(Pipeline.Workspace)/drop-package/$(Build.BuildId)-package.zip
  - deployment: DeployVM
    displayName: Deploy VM
    environment:
      name: 'VM'
      resourceType: VirtualMachine
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                #! /bin/bash
                
                sudo apt-get upgrade -y
                sudo apt-get install python3-pip -y
                sudo apt-get install unzip -y
                sudo apt-get install -y chromium-browser
                pip3 install selenium
                export PATH=$PATH:some/path


